stages:
  - build

variables:
  GIT_SUBMODULE_STRATEGY: recursive

windows_client:
  stage: build
  tags:
    - windows
  dependencies: []
  script:
    - cmake -S . -B build-windows-client -A x64,version=8.1 -T v142 -DBUILD_GROUP=game -DCMAKE_BUILD_TYPE="Release" -DBUILD_64BIT=ON -DBUILD_VPHYSICS=ON -DBUILD_VPHYSICS_TYPE="IVP" -DCMAKE_SYSTEM_VERSION="8.1" -DBUILD_FOLDER=tf2classic
    - cmake --build build-windows-client --config Release
    - cmake --install build-windows-client --config Release
  artifacts:
    paths:
    - game_tf2classic

linux_client:
  image: "registry.gitlab.steamos.cloud/steamrt/sniper/sdk"
  stage: build
  tags:
    - linux
  dependencies: []
  script:
    - export CCACHE_COMPILERCHECK=content
    - cmake -S . -B build-linux-client -G "Unix Makefiles" -DBUILD_GROUP=game -DCMAKE_BUILD_TYPE="Release" -DBUILD_64BIT=ON -DBUILD_VPHYSICS=ON -DBUILD_VPHYSICS_TYPE="IVP" -DBUILD_FOLDER=tf2classic
    - cmake --build build-linux-client -j$(nproc --all) --config Release
    - cmake --install build-linux-client --config Release
  cache:
    key: ccache-$CI_COMMIT_REF_NAME-$CI_JOB_NAME
    paths:
      - ../.ccache
  artifacts:
    paths:
    - game_tf2classic

linux_server:
  image: "registry.gitlab.steamos.cloud/steamrt/sniper/sdk"
  stage: build
  tags:
    - linux
  dependencies: []
  script:
    - export CCACHE_COMPILERCHECK=content
    - cmake -S . -B build-linux-server -G "Unix Makefiles" -DBUILD_GROUP=dedicated -DDEDICATED=1 -DCMAKE_BUILD_TYPE="Release" -DBUILD_64BIT=ON -DBUILD_VPHYSICS=ON -DBUILD_VPHYSICS_TYPE="IVP" -DBUILD_FOLDER=tf2classic -DGAMEDIR=game_tf2classic_dedicated
    - cmake --build build-linux-server -j$(nproc --all) --config Release
    - cmake --install build-linux-server --config Release
  cache:
    key: ccache-$CI_COMMIT_REF_NAME-$CI_JOB_NAME
    paths:
      - ../.ccache
  artifacts:
    paths:
    - game_tf2classic_dedicated
